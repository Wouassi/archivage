<div id="larascan-widget" class="space-y-3">

    {{-- â•â•â• HEADER STATUS â•â•â• --}}
    <div id="larascan-status" class="p-4 rounded-xl border bg-amber-50 border-amber-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span id="larascan-icon" class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-amber-500 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                </span>
                <div>
                    <h4 id="larascan-title" class="text-sm font-bold text-amber-800">â³ Chargement de Larascan...</h4>
                    <p id="larascan-subtitle" class="text-xs text-gray-500">DÃ©tection des scanners en cours</p>
                </div>
            </div>
            <button type="button" onclick="larascanInit()" class="text-xs px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50 transition">
                ğŸ”„ Actualiser
            </button>
        </div>
    </div>

    {{-- â•â•â• CONTRÃ”LES DE SCAN â•â•â• --}}
    <div id="larascan-controls" class="p-4 bg-white rounded-xl border border-gray-200 space-y-3" style="display:none">
        <div class="grid grid-cols-4 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">ğŸ“¡ Scanner</label>
                <select id="larascan-device" class="w-full text-xs rounded-lg border-gray-200 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Auto-dÃ©tection</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">ğŸ¯ RÃ©solution</label>
                <select id="larascan-dpi" class="w-full text-xs rounded-lg border-gray-200">
                    <option value="150">150 DPI</option>
                    <option value="200" selected>200 DPI</option>
                    <option value="300">300 DPI</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">ğŸ“„ Source</label>
                <select id="larascan-source" class="w-full text-xs rounded-lg border-gray-200">
                    <option value="auto">Auto-dÃ©tection</option>
                    <option value="feeder">Chargeur ADF</option>
                    <option value="flatbed">Vitre (flatbed)</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">ğŸ¨ Couleur</label>
                <select id="larascan-color" class="w-full text-xs rounded-lg border-gray-200">
                    <option value="TWPT_RGB">Couleur</option>
                    <option value="TWPT_GRAY">Niveaux de gris</option>
                    <option value="TWPT_BW">Noir et blanc</option>
                </select>
            </div>
        </div>

        <div class="flex items-center gap-3 flex-wrap">
            <button type="button" id="btn-scan" onclick="larascanScan()"
                    class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition disabled:opacity-50">
                ğŸ–¨ï¸ NumÃ©riser
            </button>
            <button type="button" onclick="larascanScanAdf()"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 rounded-xl hover:bg-indigo-100 border border-indigo-200 transition">
                ğŸ“‘ Toutes les pages (ADF)
            </button>
            <span id="larascan-count" class="text-xs font-medium px-3 py-1 rounded-full bg-gray-100 text-gray-600" style="display:none">0 page(s)</span>
        </div>
    </div>

    {{-- â•â•â• APERÃ‡U MINIATURES â•â•â• --}}
    <div id="larascan-preview" class="hidden p-3 bg-indigo-50 rounded-xl border border-indigo-200">
        <div class="flex items-center justify-between mb-2">
            <h5 class="text-xs font-bold text-indigo-700">ğŸ“ Pages numÃ©risÃ©es :</h5>
            <button type="button" onclick="larascanClearAll()" class="text-xs text-red-500 hover:text-red-700 transition">ğŸ—‘ï¸ Tout supprimer</button>
        </div>
        <div id="larascan-thumbs" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
    </div>

    {{-- â•â•â• LISTE FICHIERS SERVEUR â•â•â• --}}
    <div id="larascan-files-list" class="hidden space-y-1"></div>

</div>

@push('scripts')
<script>
(function() {
    'use strict';

    var scannedImages = [];
    var uploadedFiles = [];
    var UPLOAD_URL = @json(route('scan.upload'));
    var CSRF_TOKEN = @json(csrf_token());
    var scannerJsUrl = @json(config('larascan.scanner_js_url', 'https://cdn.asprise.com/scannerjs/scanner.js'));
    var scannerJsLoaded = false;

    // â•â•â• Charger Scanner.js dynamiquement â•â•â•
    function loadScannerJs() {
        if (typeof scanner !== 'undefined') {
            scannerJsLoaded = true;
            larascanInit();
            return;
        }
        var s = document.createElement('script');
        s.src = scannerJsUrl;
        s.onload = function() {
            scannerJsLoaded = true;
            setTimeout(larascanInit, 800);
        };
        s.onerror = function() {
            setStatus('error', 'âŒ Scanner.js non chargÃ©', 'VÃ©rifiez votre connexion internet');
        };
        document.head.appendChild(s);
    }

    // â•â•â• INIT â•â•â•
    window.larascanInit = function() {
        if (typeof scanner === 'undefined') {
            if (!scannerJsLoaded) { loadScannerJs(); return; }
            setStatus('error', 'âŒ Scanner.js non disponible', 'Le module de scan ne peut pas se charger');
            return;
        }
        setStatus('success', 'ğŸŸ¢ Larascan prÃªt', 'Scanners TWAIN/WIA dÃ©tectÃ©s automatiquement');
        document.getElementById('larascan-controls').style.display = '';
    };

    // Lancer au chargement
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { setTimeout(loadScannerJs, 500); });
    } else {
        setTimeout(loadScannerJs, 500);
    }

    // â•â•â• SCAN SIMPLE â•â•â•
    window.larascanScan = function() {
        if (typeof scanner === 'undefined') return;
        var dpi = document.getElementById('larascan-dpi').value;
        var color = document.getElementById('larascan-color').value;
        var source = document.getElementById('larascan-source').value;

        var req = {
            "use_asprise_dialog": true,
            "show_scanner_ui": false,
            "twain_cap_setting": {
                "ICAP_PIXELTYPE": color,
                "ICAP_XRESOLUTION": dpi,
                "ICAP_YRESOLUTION": dpi,
                "ICAP_SUPPORTEDSIZES": "TWSS_A4"
            },
            "output_settings": [{ "type": "return-base64", "format": "pdf" }]
        };
        if (source === 'feeder') {
            req.twain_cap_setting["CAP_FEEDERENABLED"] = true;
            req.twain_cap_setting["CAP_AUTOFEED"] = true;
        } else if (source === 'flatbed') {
            req.twain_cap_setting["CAP_FEEDERENABLED"] = false;
        }
        setBtnScanning(true);
        scanner.scan(handleScanResult, req);
    };

    // â•â•â• SCAN ADF MULTI-PAGES â•â•â•
    window.larascanScanAdf = function() {
        if (typeof scanner === 'undefined') return;
        var dpi = document.getElementById('larascan-dpi').value;
        var color = document.getElementById('larascan-color').value;
        setBtnScanning(true);
        scanner.scan(handleScanResult, {
            "use_asprise_dialog": true,
            "show_scanner_ui": false,
            "twain_cap_setting": {
                "ICAP_PIXELTYPE": color,
                "ICAP_XRESOLUTION": dpi,
                "ICAP_YRESOLUTION": dpi,
                "ICAP_SUPPORTEDSIZES": "TWSS_A4",
                "CAP_FEEDERENABLED": true,
                "CAP_AUTOFEED": true,
                "CAP_DUPLEXENABLED": false
            },
            "output_settings": [
                { "type": "return-base64", "format": "jpg" },
                { "type": "return-base64", "format": "pdf" }
            ]
        });
    };

    // â•â•â• TRAITEMENT RÃ‰SULTAT â•â•â•
    function handleScanResult(successful, mesg, response) {
        setBtnScanning(false);
        if (!successful) { setStatus('error', 'âŒ Erreur de scan', mesg || 'Erreur inconnue'); return; }
        if (mesg && mesg.toLowerCase().indexOf('user cancel') >= 0) { setStatus('warning', 'âš ï¸ AnnulÃ©', ''); return; }

        var images = scanner.getScannedImages(response, true, false);
        if (!images || images.length === 0) { setStatus('warning', 'âš ï¸ Aucune page', ''); return; }

        for (var i = 0; i < images.length; i++) { scannedImages.push(images[i]); }
        uploadScannedImages(images);
        updatePreview();
        setStatus('success', 'ğŸŸ¢ ' + images.length + ' page(s) numÃ©risÃ©e(s)', 'Total : ' + scannedImages.length);
    }

    // â•â•â• UPLOAD AU SERVEUR â•â•â•
    function uploadScannedImages(images) {
        var b64 = [];
        for (var i = 0; i < images.length; i++) { b64.push(images[i].src); }
        fetch(UPLOAD_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': CSRF_TOKEN, 'Accept': 'application/json' },
            body: JSON.stringify({ images_base64: b64 })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success && data.files) {
                data.files.forEach(function(f) { uploadedFiles.push(f); });
                syncHiddenField();
                updateFilesList();
            }
        })
        .catch(function(err) { console.error('Upload error:', err); });
    }

    // â•â•â• APERÃ‡U â•â•â•
    function updatePreview() {
        var c = document.getElementById('larascan-thumbs');
        var w = document.getElementById('larascan-preview');
        if (scannedImages.length === 0) { w.classList.add('hidden'); return; }
        w.classList.remove('hidden');
        c.innerHTML = '';
        scannedImages.forEach(function(img, idx) {
            var d = document.createElement('div');
            d.className = 'relative group';
            d.innerHTML = '<div class="aspect-[3/4] rounded-lg overflow-hidden border-2 border-indigo-200 bg-white shadow-sm">'
                + '<img src="' + img.src + '" class="w-full h-full object-cover" alt="Page ' + (idx+1) + '"/></div>'
                + '<span class="absolute top-1 left-1 inline-flex items-center justify-center w-5 h-5 text-[10px] font-bold bg-indigo-600 text-white rounded-full">' + (idx+1) + '</span>'
                + '<button type="button" onclick="larascanRemove(' + idx + ')" class="absolute top-1 right-1 w-5 h-5 text-[10px] bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition">âœ•</button>';
            c.appendChild(d);
        });
        var counter = document.getElementById('larascan-count');
        counter.textContent = scannedImages.length + ' page(s)';
        counter.style.display = '';
    }

    function updateFilesList() {
        var c = document.getElementById('larascan-files-list');
        if (uploadedFiles.length === 0) { c.classList.add('hidden'); return; }
        c.classList.remove('hidden');
        c.innerHTML = '<h5 class="text-xs font-bold text-gray-600 mb-1">ğŸ“ Fichiers envoyÃ©s :</h5>';
        uploadedFiles.forEach(function(f) {
            var d = document.createElement('div');
            d.className = 'flex items-center gap-2 py-1 px-3 bg-white rounded-lg border border-gray-100 text-xs';
            d.innerHTML = '<span class="text-emerald-500">âœ“</span><span class="font-medium">' + f.name + '</span><span class="text-gray-400">' + f.size_human + '</span>';
            c.appendChild(d);
        });
    }

    // â•â•â• ACTIONS â•â•â•
    window.larascanRemove = function(idx) {
        scannedImages.splice(idx, 1);
        if (uploadedFiles[idx]) uploadedFiles.splice(idx, 1);
        syncHiddenField(); updatePreview(); updateFilesList();
    };
    window.larascanClearAll = function() {
        scannedImages = []; uploadedFiles = [];
        syncHiddenField(); updatePreview(); updateFilesList();
        document.getElementById('larascan-count').style.display = 'none';
        fetch('/scan/clear', { method: 'DELETE', headers: { 'X-CSRF-TOKEN': CSRF_TOKEN, 'Accept': 'application/json' } });
    };

    // â•â•â• SYNC FILAMENT â•â•â•
    function syncHiddenField() {
        var paths = uploadedFiles.map(function(f) { return f.path; }).join(',');
        var hidden = document.querySelector('input[name="fichiers_pdf_paths"]');
        if (hidden) { hidden.value = paths; hidden.dispatchEvent(new Event('input', { bubbles: true })); }
    }

    // â•â•â• UI HELPERS â•â•â•
    function setStatus(type, title, subtitle) {
        var box = document.getElementById('larascan-status');
        var icon = document.getElementById('larascan-icon');
        var colors = {
            success: { bg: '#ecfdf5', border: '#a7f3d0', iconBg: '#10b981', text: '#065f46' },
            error:   { bg: '#fef2f2', border: '#fecaca', iconBg: '#ef4444', text: '#991b1b' },
            warning: { bg: '#fffbeb', border: '#fde68a', iconBg: '#f59e0b', text: '#92400e' },
            info:    { bg: '#eff6ff', border: '#bfdbfe', iconBg: '#3b82f6', text: '#1e40af' }
        };
        var c = colors[type] || colors.info;
        box.style.background = c.bg; box.style.borderColor = c.border;
        icon.style.background = c.iconBg;
        document.getElementById('larascan-title').textContent = title;
        document.getElementById('larascan-title').style.color = c.text;
        document.getElementById('larascan-subtitle').textContent = subtitle || '';
    }
    function setBtnScanning(active) {
        var btn = document.getElementById('btn-scan');
        if (active) {
            btn.disabled = true; btn.innerHTML = 'â³ NumÃ©risation...';
            btn.classList.add('animate-pulse', 'bg-amber-500'); btn.classList.remove('bg-indigo-600');
        } else {
            btn.disabled = false; btn.innerHTML = 'ğŸ–¨ï¸ NumÃ©riser';
            btn.classList.remove('animate-pulse', 'bg-amber-500'); btn.classList.add('bg-indigo-600');
        }
    }
})();
</script>
@endpush